<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Rowspan Grid</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1e1e1e;
            color: #ffffff;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 14px;
            overflow: hidden;
        }

        .spreadsheet-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .spreadsheet-table {
            flex: 1;
            width: 100%;
            border-collapse: collapse;
        }

        .row {
            border-bottom: 1px solid #404040;
        }

        .cell {
            border-right: 1px solid #404040;
            padding: 8px 12px;
            vertical-align: top;
            outline: none;
            min-height: 40px;
            line-height: 24px;
        }

        .cell:focus {
            background: #2d2d2d;
            border: 2px solid #4fc3f7;
            margin: -1px;
        }

        .command-cell {
            width: 120px;
            font-weight: bold;
            color: #4fc3f7;
            background: #242424;
            border-bottom: 1px solid #404040;
        }

        .param-key-cell {
            width: 120px;
            color: #ffb74d;
            background: #282828;
        }

        .param-value-cell {
            color: #81c784;
            background: #1e1e1e;
            width: auto;
        }

        .cell[contenteditable="true"]:empty::before {
            content: attr(data-placeholder);
            color: #666666;
            font-style: italic;
        }

        .command-cell:focus {
            background: #2d4d5d;
        }

        .param-key-cell:focus {
            background: #3d3d2d;
        }

        .param-value-cell:focus {
            background: #2d3d2d;
        }
    </style>
</head>
<body>
    <div class="spreadsheet-container">
        <table class="spreadsheet-table" id="grid">
            <!-- Rows will be generated by JavaScript -->
        </table>
    </div>

    <script>
        class SimpleGrid {
            constructor(container) {
                this.container = container;
                this.data = [];
                this.currentFocus = { row: 0, col: 0 };
                this.init();
            }

            init() {
                // Start with a few commands
                this.addCommand();
                this.render();
                this.setupEventListeners();
                
                // Focus first cell
                setTimeout(() => {
                    this.focusCell(0, 0);
                }, 100);
            }

            addCommand() {
                this.data.push({
                    type: 'command',
                    command: '',
                    parameters: [
                        { key: '', value: '' },
                        { key: '', value: '' }
                    ]
                });
            }

            render() {
                let html = '';
                let globalRowIndex = 0;

                this.data.forEach((commandData, commandIndex) => {
                    const paramCount = commandData.parameters.length;
                    
                    // Command row (spans multiple rows)
                    html += `
                        <tr class="row">
                            <td class="cell command-cell" 
                                rowspan="${paramCount}"
                                contenteditable="true" 
                                data-row="${globalRowIndex}" 
                                data-col="0"
                                data-command-index="${commandIndex}"
                                data-placeholder="Type command...">${commandData.command}</td>
                            <td class="cell param-key-cell" 
                                contenteditable="true" 
                                data-row="${globalRowIndex}" 
                                data-col="1"
                                data-command-index="${commandIndex}"
                                data-param-index="0"
                                data-placeholder="parameter...">${commandData.parameters[0].key}</td>
                            <td class="cell param-value-cell" 
                                contenteditable="true" 
                                data-row="${globalRowIndex}" 
                                data-col="2"
                                data-command-index="${commandIndex}"
                                data-param-index="0"
                                data-placeholder="value...">${commandData.parameters[0].value}</td>
                        </tr>
                    `;
                    globalRowIndex++;

                    // Additional parameter rows
                    for (let i = 1; i < paramCount; i++) {
                        html += `
                            <tr class="row">
                                <td class="cell param-key-cell" 
                                    contenteditable="true" 
                                    data-row="${globalRowIndex}" 
                                    data-col="1"
                                    data-command-index="${commandIndex}"
                                    data-param-index="${i}"
                                    data-placeholder="parameter...">${commandData.parameters[i].key}</td>
                                <td class="cell param-value-cell" 
                                    contenteditable="true" 
                                    data-row="${globalRowIndex}" 
                                    data-col="2"
                                    data-command-index="${commandIndex}"
                                    data-param-index="${i}"
                                    data-placeholder="value...">${commandData.parameters[i].value}</td>
                            </tr>
                        `;
                        globalRowIndex++;
                    }
                });
                
                this.container.innerHTML = html;
            }

            setupEventListeners() {
                this.container.addEventListener('input', (e) => {
                    const cell = e.target;
                    if (!cell.classList.contains('cell')) return;

                    const commandIndex = parseInt(cell.dataset.commandIndex);
                    const col = parseInt(cell.dataset.col);
                    
                    if (col === 0) {
                        // Command cell
                        this.data[commandIndex].command = cell.textContent;
                    } else {
                        // Parameter cell
                        const paramIndex = parseInt(cell.dataset.paramIndex);
                        if (col === 1) {
                            this.data[commandIndex].parameters[paramIndex].key = cell.textContent;
                        } else {
                            this.data[commandIndex].parameters[paramIndex].value = cell.textContent;
                        }
                    }

                    // Auto-expand: add new command if typing in last row
                    const isLastCommand = commandIndex === this.data.length - 1;
                    const isLastParam = col > 0 && parseInt(cell.dataset.paramIndex) === this.data[commandIndex].parameters.length - 1;
                    
                    if (isLastCommand && (col === 0 || isLastParam) && cell.textContent.trim()) {
                        this.addCommand();
                        this.render();
                        this.restoreFocus();
                    }
                });

                this.container.addEventListener('keydown', (e) => {
                    this.handleKeydown(e);
                });

                this.container.addEventListener('focus', (e) => {
                    if (e.target.classList.contains('cell')) {
                        const row = parseInt(e.target.dataset.row);
                        const col = parseInt(e.target.dataset.col);
                        this.currentFocus = { row, col };
                    }
                }, true);
            }

            handleKeydown(e) {
                const { row, col } = this.currentFocus;

                switch (e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        this.focusCell(Math.max(0, row - 1), col);
                        break;
                    
                    case 'ArrowDown':
                        e.preventDefault();
                        this.focusCell(row + 1, col);
                        break;
                    
                    case 'ArrowLeft':
                        if (this.getCursorPosition() === 0) {
                            e.preventDefault();
                            this.focusCell(row, Math.max(0, col - 1));
                        }
                        break;
                    
                    case 'ArrowRight':
                        const cell = document.activeElement;
                        if (this.getCursorPosition() === cell.textContent.length) {
                            e.preventDefault();
                            this.focusCell(row, Math.min(2, col + 1));
                        }
                        break;
                    
                    case 'Tab':
                        e.preventDefault();
                        if (e.shiftKey) {
                            this.navigatePrevious();
                        } else {
                            this.navigateNext();
                        }
                        break;
                    
                    case 'Enter':
                        e.preventDefault();
                        this.focusCell(row + 1, col);
                        break;
                }
            }

            navigateNext() {
                const { row, col } = this.currentFocus;
                
                if (col < 2) {
                    this.focusCell(row, col + 1);
                } else {
                    this.focusCell(row + 1, 0);
                }
            }

            navigatePrevious() {
                const { row, col } = this.currentFocus;
                
                if (col > 0) {
                    this.focusCell(row, col - 1);
                } else if (row > 0) {
                    this.focusCell(row - 1, 2);
                }
            }

            focusCell(row, col) {
                const totalRows = this.getTotalRowCount();
                
                // Clamp row to valid range
                row = Math.max(0, Math.min(row, totalRows - 1));
                
                // Find the cell at this row/col
                const cell = this.container.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                if (cell) {
                    cell.focus();
                    this.currentFocus = { row, col };
                } else if (col === 0) {
                    // Command cell might not exist at this exact row due to rowspan
                    // Find the nearest command cell
                    const commandCell = this.container.querySelector(`[data-row<="${row}"][data-col="0"]`);
                    if (commandCell) {
                        commandCell.focus();
                        this.currentFocus = { row: parseInt(commandCell.dataset.row), col: 0 };
                    }
                }
            }

            restoreFocus() {
                this.focusCell(this.currentFocus.row, this.currentFocus.col);
            }

            getTotalRowCount() {
                return this.data.reduce((count, command) => count + command.parameters.length, 0);
            }

            getCursorPosition() {
                const selection = window.getSelection();
                return selection.anchorOffset;
            }
        }

        // Initialize the spreadsheet
        document.addEventListener('DOMContentLoaded', () => {
            const grid = document.getElementById('grid');
            new SimpleGrid(grid);
        });
    </script>
</body>
</html> 
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Discrete Conformal Mapping for Circle Packing</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      canvas {
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <canvas id="circlePacking" width="800" height="800"></canvas>

    <script>
      const canvas = document.getElementById("circlePacking");
      const ctx = canvas.getContext("2d");

      const width = canvas.width;
      const height = canvas.height;
      const radius = Math.min(width, height) / 2 - 10; // Disk radius
      const circleRadius = 10; // Initial radius of circles
      const circles = []; // Stores circle data

      /**
       * Generates a hexagonal grid
       */
      function generateHexagonalGrid() {
        const gridRadius = radius; // Initial bounding circle
        const spacing = circleRadius * Math.sqrt(3);
        let y = -gridRadius;

        while (y <= gridRadius) {
          let xOffset =
            Math.floor((y / spacing) % 2) === 0 ? 0 : circleRadius * 1.5;
          let x = -gridRadius + xOffset;

          while (x <= gridRadius) {
            const dist = Math.sqrt(x * x + y * y);
            if (dist + circleRadius <= gridRadius) {
              circles.push({ x, y, r: circleRadius });
            }
            x += circleRadius * 2;
          }

          y += spacing;
        }
      }

      /**
       * Maps circles to fit inside the target disk using a conformal mapping
       */
      function applyConformalMapping() {
        const center = { x: width / 2, y: height / 2 };

        for (const circle of circles) {
          // Normalize to unit disk
          const dist = Math.sqrt(circle.x * circle.x + circle.y * circle.y);
          const scale = radius / dist;

          circle.x = center.x + circle.x * scale;
          circle.y = center.y + circle.y * scale;
          circle.r = circle.r * scale;
        }
      }

      /**
       * Draw circles on the canvas
       */
      function drawCircles() {
        ctx.clearRect(0, 0, width, height);

        for (const circle of circles) {
          ctx.beginPath();
          ctx.arc(circle.x, circle.y, circle.r, 0, Math.PI * 2);
          ctx.fillStyle = `hsl(${Math.random() * 360}, 70%, 70%)`;
          ctx.fill();
          ctx.strokeStyle = "#333";
          ctx.stroke();
          ctx.closePath();
        }
      }

      // Generate grid, map it, and draw the result
      generateHexagonalGrid();
      applyConformalMapping();
      drawCircles();
    </script>
  </body>
</html>
